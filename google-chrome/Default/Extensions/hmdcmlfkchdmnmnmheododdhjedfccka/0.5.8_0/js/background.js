(()=>{var e={tab:null,tabs:[],version:17,screenshotData:"",screenshotFormat:"png",canvas:document.createElement("canvas"),canvasContext:null,debugImage:null,debugTab:0,history:{version:17,last_color:"#b48484",current_palette:"default",palettes:[]},defaultSettings:{autoClipboard:!1,autoClipboardNoGrid:!1,enableColorToolbox:!0,enableColorTooltip:!0,enableRightClickDeactivate:!0,dropperCursor:"default",plus:!1,plus_type:null},defaultPalette:"default",settings:{},edCb:null,color_sources:{1:"Web Page",2:"Color Picker",3:"Old History"},useTab:function(t){e.tab=t,e.screenshotData="",e.canvas=document.createElement("canvas"),e.canvasContext=null},checkDropperScripts:function(){e.sendMessage({type:"edropper-version"},(function(t){chrome.runtime.lastError||!t?e.injectDropper():t.version<12?e.refreshDropper():e.pickupActivate()}))},injectDropper:function(){chrome.tabs.executeScript(e.tab.id,{file:"/js/edropper2.js"},(function(t){e.pickupActivate()}))},refreshDropper:function(){chrome.tabs.executeScript(e.tab.id,{allFrames:!0,file:"/js/edropper2.js"},(function(t){e.pickupActivate()}))},sendMessage:function(t,o){chrome.tabs.sendMessage(e.tab.id,t,o)},shortcutListener:function(){chrome.commands.onCommand.addListener((t=>{switch(t){case"activate":e.activate2()}}))},messageListener:function(){chrome.runtime.onMessage.addListener(((t,o,a)=>{switch(t.type){case"activate-from-hotkey":e.activate2(),a({});break;case"reload-background":window.location.reload();break;case"clear-history":e.clearHistory(a)}})),chrome.runtime.onConnect.addListener((t=>{t.onMessage.addListener(((t,o)=>{switch(t.type){case"screenshot":e.capture();break;case"debug-tab":e.debugImage=t.image,e.createDebugTab();break;case"set-color":e.setColor("#"+t.color.rgbhex,!0,1,o.sender.url)}}))})),chrome.runtime.onInstalled.addListener((e=>{"install"===e.reason&&chrome.tabs.create({url:"https://eyedropper.org/installed",selected:!0})}))},setBadgeColor:function(e){chrome.browserAction.setBadgeBackgroundColor({color:[parseInt(e.substr(1,2),16),parseInt(e.substr(3,2),16),parseInt(e.substr(5,2),16),255]})},setColor:function(t,o=!0,a=1,r){t&&t.match(/^#[0-9a-f]{6}$/)&&(e.setBadgeColor(t),e.history.last_color=t,e.settings.autoClipboard&&e.copyToClipboard(t),o&&e.saveToHistory(t,a,r))},saveToHistory:function(t,o=1,a){var r=e.getPalette();r.colors.find((e=>e.h==t))||(r.colors.push(e.historyColorItem(t,Date.now(),o,!1,a)),e.saveHistory())},copyToClipboard:function(t){e.edCb.value=e.settings.autoClipboardNoGrid?t.substring(1):t,e.edCb.select(),document.execCommand("copy",!1,null)},activate2:function(){chrome.tabs.query({active:!0},(t=>{e.useTab(t[0]),e.activate()}))},activate:function(){e.checkDropperScripts()},pickupActivate:function(){e.sendMessage({type:"pickup-activate",options:{cursor:e.settings.dropperCursor,enableColorToolbox:e.settings.enableColorToolbox,enableColorTooltip:e.settings.enableColorTooltip,enableRightClickDeactivate:e.settings.enableRightClickDeactivate}})},capture:function(){try{chrome.tabs.captureVisibleTab(null,{format:"png"},e.doCapture)}catch(t){chrome.tabs.captureVisibleTab(null,e.doCapture)}},getColor:function(){return e.history.last_color},doCapture:function(t){t&&e.sendMessage({type:"update-image",data:t})},createDebugTab:function(){0!=e.debugTab?chrome.tabs.sendMessage(e.debugTab,{type:"update"}):chrome.tabs.create({url:"/debug-tab.html",selected:!1},(function(t){e.debugTab=t.id}))},tabOnChangeListener:function(){chrome.tabs.onSelectionChanged.addListener(((t,o)=>{e.tab&&e.tab.id==t&&e.sendMessage({type:"pickup-deactivate"})}))},getPaletteName:function(){return e.getPalette().name},isPalette:function(t){return!!e.history.palettes.find((e=>e.name==t))},getPalette:function(t){return void 0===t&&(t=void 0!==e.history.current_palette&&e.isPalette(e.history.current_palette)?e.history.current_palette:"default"),e.history.palettes.find((e=>e.name==t))},changePalette:function(t){e.history.current_palette===t||e.isPalette(t)&&(e.history.current_palette=t,e.saveHistory())},getPaletteNames:function(){return e.history.palettes.map((e=>e.name))},uniquePaletteName:function(t){if(void 0===t||!t||t.length<1)return e.uniquePaletteName("palette");if(e.getPaletteNames().find((e=>e==t))){var o=t.match(/^(.*[^\d]+)(\d+)?$/);if(void 0===o[2])return e.uniquePaletteName(t+"1");var a=""+o[1]+(parseInt(o[2])+1);return e.uniquePaletteName(a)}return t},createPalette:function(t){var o=e.uniquePaletteName(t);return e.history.palettes.push({name:o,created:Date.now(),colors:[]}),e.saveHistory(),e.getPalette(o)},destroyPalette:function(t){if(e.isPalette(t)){if("default"===t)e.getPalette(t).colors=[];else{var o=t===e.getPalette().name;e.history.palettes=e.history.palettes.filter((e=>e.name!==t)),o&&e.changePalette("default")}e.saveHistory(!1),chrome.storage.sync.remove("palette."+t)}},clearHistory:function(t){e.getPalette().colors=[],e.saveHistory(),null!=t&&t({state:"OK"})},loadHistory:function(){chrome.storage.sync.get((t=>{if(t.history){e.history.current_palette=t.history.cp,e.history.last_color=t.history.lc;var o=0,a=0;Object.keys(t).forEach(((r,s)=>{var n=r.match(/^palette\.(.*)$/);if(n){var i=t[r];e.history.palettes.push({name:n[1],colors:i.c,created:i.t}),"default"===n[1]&&(o=i.c.length),"converted"===n[1]&&(a=i.c.length)}})),0===o&&a>0&&(e.defaultPalette="converted"),t.history.v<e.history.version&&e.checkHistoryUpgrades(t.history.v)}else e.createPalette("default");e.tryConvertOldHistory()}))},checkHistoryUpgrades:function(t){if(t<14){for(var o=0,a=e.history.palettes;o<a.length;o++)for(var r=0,s=a[o].colors;r<s.length;r++){var n=s[r];"number"!=typeof n.t&&(n.t=0)}e.saveHistory()}},loadSettings:function(){chrome.storage.sync.get("settings",(function(t){t.settings?e.settings=t.settings:e.tryConvertOldSettings()}))},historyColorItem:function(e,t=Date.now(),o=1,a=!1,r){return{h:e,n:"",s:o,t,f:a?1:0}},tryConvertOldHistory:function(){if(window.localStorage.history){var t=JSON.parse(window.localStorage.history),o=e.createPalette("converted"),a=Date.now();for(var r in t){var s=t[r];"#"!=s[0]&&(s="#"+s),o.colors.push(e.historyColorItem(s,a,3)),e.history.last_color=s}window.localStorage._history_backup=window.localStorage.history,window.localStorage.removeItem("history"),e.saveHistory(),e.getPalette().colors.length<1&&e.changePalette(o.name)}},tryConvertOldSettings:function(){e.settings=e.defaultSettings,e.settings.autoClipboard="true"===window.localStorage.autoClipboard,e.settings.autoClipboardNoGrid="true"===window.localStorage.autoClipboardNoGrid,e.settings.enableColorToolbox="false"!==window.localStorage.enableColorToolbox,e.settings.enableColorTooltip="false"!==window.localStorage.enableColorTooltip,e.settings.enableRightClickDeactivate="false"!==window.localStorage.enableRightClickDeactivate,e.settings.dropperCursor="crosshair"===window.localStorage.dropperCursor?"crosshair":"default",e.saveSettings();for(var t=0,o=["autoClipboard","autoClipboardNoGrid","enableColorTooltip","enableColorToolbox","enableRightClickDeactivate","dropperCursor"];t<o.length;t++){var a=o[t];localStorage.removeItem(a)}},saveHistory:function(t=!0){var o={history:{v:e.history.version,cp:e.history.current_palette,lc:e.history.last_color}};if(t)for(var a=0,r=e.history.palettes;a<r.length;a++){const e=r[a];o["palette."+e.name]={c:e.colors,t:e.created}}chrome.storage.sync.set(o,(function(){}))},saveSettings:function(){chrome.storage.sync.set({settings:e.settings},(function(){}))},unlockPlus:function(t){e.settings.plus=!0,e.settings.plus_type=t,e.saveSettings()},lockPlus:function(){e.settings.plus=!1,e.settings.plus_type=null,e.saveSettings()},plus:function(){return!!e.settings.plus&&e.settings.plus_type},plusColor:function(t=e.settings.plus_type){switch(t){case"free":return"gray";case"alpha":return"silver";default:return t}},init:function(){e.edCb=document.getElementById("edClipboard"),e.loadSettings(),e.loadHistory(),chrome.browserAction.setBadgeText({text:" "}),e.messageListener(),e.tabOnChangeListener(),e.shortcutListener()}};document.addEventListener("DOMContentLoaded",(function(){e.init()})),window.bg=e})();